<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBJ + MTL Model Testing</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: black;
            font-family: sans-serif;
            font-size: 1.2em;
            padding: 0 10px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="info">Loading 3D Model...</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.163.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';

        const infoDiv = document.getElementById('info');
        
        try {
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeeeeee);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
            directionalLight.position.set(10, 20, 5);
            scene.add(directionalLight);

            const mtlLoader = new MTLLoader();
            const objLoader = new OBJLoader();

            const mtlFileName = 'FloorPlan_Hydro.mtl';
            const objFileName = 'FloorPlan_Hydro.obj';

            mtlLoader.load(
                mtlFileName,
                function(materials) {
                    materials.preload();
                    objLoader.setMaterials(materials);

                    objLoader.load(
                        objFileName,
                        function (object) {
                            infoDiv.textContent = 'Model Loaded Successfully! You can now interact.';
                            
                            // --- DEFINITIVE Auto-center and auto-zoom fix ---
                            const box = new THREE.Box3().setFromObject(object);
                            const size = box.getSize(new THREE.Vector3());
                            const center = box.getCenter(new THREE.Vector3());

                            // Move the object's center to the origin
                            object.position.x += (object.position.x - center.x);
                            object.position.y += (object.position.y - center.y);
                            object.position.z += (object.position.z - center.z);
                            
                            // Set camera position to fit the object
                            const maxDim = Math.max(size.x, size.y, size.z);
                            const fov = camera.fov * (Math.PI / 180);
                            let cameraZ = Math.abs(maxDim / 2 * Math.tan(fov * 2));
                            
                            camera.position.z = center.z + cameraZ * 2; // Position camera away from the object
                            
                            const minZ = box.min.z;
                            const cameraToFarEdge = ( minZ < 0 ) ? -minZ + cameraZ : cameraZ;

                            camera.far = cameraToFarEdge * 3;
                            camera.updateProjectionMatrix();

                            // Set the controls target to the center of the object
                            controls.target.copy(center);
                            controls.update();
                            // --- End of fix ---
                            
                            scene.add(object);
                        },
                        function (xhr) {
                            if (xhr.lengthComputable) {
                                const percentLoaded = (xhr.loaded / xhr.total * 100);
                                infoDiv.textContent = `Loading OBJ: ${percentLoaded.toFixed(2)}%`;
                            }
                        },
                        function (error) {
                            console.error('An error happened during OBJ loading:', error);
                            infoDiv.innerHTML = `<span style="color: red;"><strong>Error:</strong> Could not load the OBJ file. Ensure 'FloorPlan_Hydro.obj' is in the root of your repository and the name is exact.</span>`;
                        }
                    );
                },
                function (xhr) {
                    if (xhr.lengthComputable) {
                        const percentLoaded = (xhr.loaded / xhr.total * 100);
                        infoDiv.textContent = `Loading MTL: ${percentLoaded.toFixed(2)}%`;
                    }
                },
                function (error) {
                     // Fallback if MTL is not found
                    console.warn("Could not load MTL, attempting to load OBJ with basic material.");
                    objLoader.load(objFileName, (object) => {
                         infoDiv.textContent = 'Model Loaded Successfully (Basic Materials)! You can now interact.';
                         const box = new THREE.Box3().setFromObject(object);
                         const size = box.getSize(new THREE.Vector3());
                         const center = box.getCenter(new THREE.Vector3());
                         object.position.x += (object.position.x - center.x);
                         object.position.y += (object.position.y - center.y);
                         object.position.z += (object.position.z - center.z);
                         const maxDim = Math.max(size.x, size.y, size.z);
                         const fov = camera.fov * (Math.PI / 180);
                         let cameraZ = Math.abs(maxDim / 2 * Math.tan(fov * 2));
                         camera.position.z = center.z + cameraZ * 2;
                         const minZ = box.min.z;
                         const cameraToFarEdge = ( minZ < 0 ) ? -minZ + cameraZ : cameraZ;
                         camera.far = cameraToFarEdge * 3;
                         camera.updateProjectionMatrix();
                         controls.target.copy(center);
                         controls.update();
                         scene.add(object);
                    });
                }
            );

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }, false);

        } catch(e) {
            console.error("A critical error occurred:", e);
            infoDiv.innerHTML = `<span style="color: red;"><strong>Critical Error:</strong> Something went wrong with the 3D setup. Details: ${e.message}</span>`;
        }
    </script>
</body>
</html>
